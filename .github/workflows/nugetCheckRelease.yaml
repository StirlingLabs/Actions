name: NuPkg Release Check

on:
  workflow_call:
    inputs:
      upstream:
        description: Project owner/name (the path part of a GitHub repo URL)
        type: string
        required: false
        default: ${{ github.repository }}
      rids:
        description: Runtime identifiers for the platforms to test in a simple list (space separated)
        type: string
        default: 'linux-x64 osx win-x64'
      releasePrefix:
        description: Irrelevant prefix to ignore before the release version number (e.g. 'v')
        type: string
        required: false
      ignoreReleases:
        description: Simple list of version numbers to ignore (space separated)
        type: string
        required: false
      nupkgName:
        description: The package name to test (with the text 'RID' in place of the RID), e.g. StirlingLabs.project.RID.suffix
        type: string
        required: true
      forceVersion:
        description: Force a specific version number to be tested & released
        type: string
        required: false

    outputs:
      releasesNeeded:
        description: JSON array of the version numbers that do not have all of the required packages (i.e. one for each RID)
        value: ${{ jobs.check.outputs.releasesNeeded }}
      continue:
        description: Boolean value; true if there are releases needed
        value: ${{ jobs.check.outputs.continue }}
      githubApiUrl:
        description: GitHub API base URL for the repo
        value: ${{ jobs.check.outputs.githubApi }}
      releasesUrl:
        description: GitHub API URL to list all releases for the repo
        value: ${{ jobs.check.outputs.releasesUrl }}
      tagsUrl:
        description: GitHub API URL to list all tags for the repo
        value: ${{ jobs.check.outputs.tagsUrl }}
      tagUrl:
        description: GitHub API URL to list details of a specific tag in the repo (append the tag name)
        value: ${{ jobs.check.outputs.tagUrl }}
      gitUrl:
        description: GitHub project git URL
        value: ${{ jobs.check.outputs.gitUrl }}
      platformArray:
        description: Platform identifiers of the platforms required in a JSON array
        value: ${{ jobs.check.outputs.platformArray }}
      ridArray:
        description: Runtime identifiers of the platforms tested in a JSON array
        value: ${{ jobs.check.outputs.ridArray }}
      rids:
        description: Runtime identifiers from input in a simple list
        value: ${{ inputs.rids }}
      upstream:
        description:  Project owner/name (like GitHub repo URL) provided as input
        value: ${{ inputs.upstream }}
      releasePrefix:
        description: Irrelevant prefix to ignore before the release version number (e.g. 'v') provided as input
        value: ${{ inputs.releasePrefix }}

jobs:
  check:
    name: Status
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    outputs:
      releasesNeeded: ${{ steps.requirements.outputs.releasesNeeded }}
      continue: ${{ steps.requirements.outputs.continue }}
      githubApi: ${{ steps.github.outputs.githubApi }}
      releasesUrl: ${{ steps.github.outputs.releasesUrl }}
      tagsUrl: ${{ steps.github.outputs.tagsUrl }}
      tagUrl: ${{ steps.github.outputs.tagUrl }}
      gitUrl: ${{ steps.github.outputs.gitUrl }}
      ridArray: ${{ steps.arrays.outputs.ridArray }}
      platformArray: ${{ steps.arrays.outputs.platformArray }}
    steps:
      - name: GitHub Release List
        id: github
        env:
          upstream: ${{ inputs.upstream }}
          releasePrefix: ${{ inputs.releasePrefix }}
          ignoreReleases: ${{ inputs.ignoreReleases }}
          forceVersion: ${{ inputs.forceVersion }}
        run: |
          continue="false"
          # GitHub info
          releasesUrl="https://api.github.com/repos/${upstream}/releases"
          # Make these URLs available for other scripts
          #shellcheck disable=SC2129
          echo "releasesUrl=${releasesUrl}" >> "$GITHUB_OUTPUT"
          echo "githubApi=https://api.github.com/repos/${upstream}" >> "$GITHUB_OUTPUT"
          echo "tagsUrl=https://api.github.com/repos/${upstream}/tags" >> "$GITHUB_OUTPUT"
          echo "tagUrl=https://api.github.com/repos/${upstream}/git/ref/tags/" >> "$GITHUB_OUTPUT"
          echo "gitUrl=git://github.com/${upstream}.git" >> "$GITHUB_OUTPUT"
          if [[ "$forceVersion" != "" ]] ; then
            echo "‼️ Forcing version ${forceVersion}"
            echo "validReleaseList=\"${forceVersion}\"" >> "$GITHUB_OUTPUT"
            echo "continue=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # Get release data
          releasesJson="$(jq -c . <<< "$(curl -s "${releasesUrl}")")"
          releaseList="$(jq -r ".[].tag_name" <<< "$releasesJson")"
          echo "release list:"
          mapfile -t releaseArray <<< "$releaseList"
          validReleaseList="" && validReleaseListComma=""
          for release in "${releaseArray[@]}" ; do
            # Skip releases in the ignore list
            version=${release#"$releasePrefix"}
            #echo "- Checking ${release} == ${version}"
            if [[ "${ignoreReleases}" != *"\"${version}\""* ]] && \
               [[ "${ignoreReleases}" != *" ${version} "* ]] && \
               [[ "${ignoreReleases}" != *"\"${release}\""* ]] && \
               [[ "${ignoreReleases}" != *" ${release} "* ]]
            then
              validReleaseList="${validReleaseList}${validReleaseListComma}\"${release}\""
              validReleaseListComma=" "
              echo "- ${release} added"
            else
              echo "- ${release} ignored"
            fi
          done
          [[ "$validReleaseList" == "" ]] && continue="false" || continue="true"
          echo "releases=${validReleaseList}" >> "$GITHUB_OUTPUT"
          echo "continue=${continue}" >> "$GITHUB_OUTPUT"
      - name: NuGet Package List
        id: nuget
        if: ${{ steps.github.outputs.continue == 'true' }}
        env:
          rids: ${{ inputs.rids }}
          nupkgName: ${{ inputs.nupkgName }}
        run: |
          # Gather NuGet release info
          main() {
            continue="false"
            pkgVersions="" && pkgVersionsComma=""
            if [[ "$nupkgName" == *".RID."* ]] && [[ "$rids" != "" ]]  && [[ "$rids" != " " ]]; then
              echo "RID-specific NuGet package $nupkgName -> $rids"
              mapfile -t rids <<< "$rids"
              for rid in $rids ; do
                nupkg="${nupkgName/.RID./".${rid}."}"
                versions="$(getPackageVersions "$nupkg")"
                mapfile -t versionArray <<< "$versions"
                for version in "${versionArray[@]}" ; do
                  [[ "$pkgVersions" == *"\"$version\""* ]] && continue # Skip duplicates
                  pkgVersions="${pkgVersions}${pkgVersionsComma}\"${version}\""
                  pkgVersionsComma=" "
                done
              done            
            else
              echo "Getting list for $nupkgName"
              pkgVersions="$(getPackageVersions "$nupkgName")"
            fi
            echo "NuGet has: ${pkgVersions}"
            echo "versions=${pkgVersions}" >> "$GITHUB_OUTPUT"
            [[ "$pkgVersions" == "" ]] && continue="false" || continue="true"
            echo -e "continue:$continue\nNuGet package versions:${pkgVersions}"
            echo "continue=${continue}" >> "$GITHUB_OUTPUT"
          }
          
          function getPackageVersions() {
            local nupkg="$1"
            local packagesUrl="https://api.nuget.org/v3-flatcontainer/${nupkg}/index.json"
            local packagesRaw && packagesRaw="$(curl -s "${packagesUrl}")"
            if [[ "$packagesRaw" == *"BlobNotFound"* ]] ; then
              echo "No packages found for $nupkg" >&2
            elif [[ "$packagesRaw" == *"Error"* ]] ; then
              echo -e "Problem while processing ${nupkg} at ${packagesUrl}:\n${packagesRaw}\n" >&2
              exit 1
            else
              jq -r ".versions|sort|to_entries[]|(.value)" <<< "$packagesRaw"
            fi
          }
          main "$@" ; exit $?

      - name: Determine Requirements
        id: requirements
        if: ${{ steps.nuget.outputs.continue == 'true' }}
        env:
          releasePrefix: ${{ inputs.releasePrefix }}
          nugetVersions: ${{ steps.nuget.outputs.versions }}
          githubReleases: ${{ steps.github.outputs.releases }}
        run: |
          #
          # Get a list of upstream releases that do not have all of the required packages
          continue="false"
          releasesNeeded="[ " && releasesNeededSpace=" "
          echo "Determining requirements"
          mapfile -t releaseArray <<< "$githubReleases"
          for release in "${releaseArray[@]}" ; do
            version=${release#"$releasePrefix"}
            echo "${release} ~ ${version}"
            if [[ "$nugetVersions" != *"\"${version}\""* ]] ; then
              echo "Need ${release} ~ ${version}"
              continue="true"
              releasesNeeded="${releasesNeeded}${releasesNeededSpace}\"${release}\""
              releasesNeededSpace=", "
            else
              echo "Have ${release} ~ ${version}"
            fi
          done
          releasesNeeded="${releasesNeeded} ]"
          echo "continue=${continue}" >> "$GITHUB_OUTPUT"
          echo "releasesNeeded=${releasesNeeded}" >> "$GITHUB_OUTPUT"
          echo -e "continue: $continue\nReleases needed: ${releasesNeeded}"

      - name: Arrays
        id: arrays
        if: ${{ steps.requirements.outputs.continue == 'true' }}
        env:
          rids: ${{ inputs.rids }}
        run: |
          ridArray="[ " && ridArrayComma=""
          platformArray="[ " && platformArrayComma=""
          for rid in $rids ; do
            ridArray="${ridArray}${ridArrayComma}\"${rid}\""
            ridArrayComma=", "
            case "$rid" in
              "linux-x64") platform="ubuntu-latest" ;;
              "osx") platform="macos-latest" ;;
              "win-x64") platform="windows-latest" ;;
              *) platform="ubuntu-latest" ;;
            esac
            platformArray="${platformArray}${platformArrayComma}\"${platform}\""
            platformArrayComma=", "
          done
          ridArray="${ridArray} ]"
          platformArray="${platformArray} ]"
          echo "ridArray=$ridArray" >> "$GITHUB_OUTPUT"
          echo "platformArray=$platformArray" >> "$GITHUB_OUTPUT"
          #end
